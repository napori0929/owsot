<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>OWSOT Dashboard</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' http://localhost:3000">
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #1e1e1e;
      color: #fff;
      padding: 10px;
      max-width: 420px;
      margin: 0 auto;
      font-size: 12px;
    }
    h1 { color: #00ffff; margin-bottom: 6px; font-size: 16px; }
    h2 { color: #aee; margin: 6px 0 4px; font-size: 13px; }
    label { display: block; margin: 3px 0; }
    input, select, button {
      background: #2b2b2b;
      border: 1px solid #555;
      color: #fff;
      padding: 3px 4px;
      border-radius: 3px;
      font-size: 11px;
    }
    select { width: 150px; }
    button {
      margin-top: 6px;
      padding: 6px 10px;
      background: #00bcd4;
      border: 0;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 11px;
    }
    button:hover { background: #0097a7; }
    .row { border-top: 1px solid #333; padding-top: 6px; margin-top: 10px; }
    #status { margin-top: 6px; font-size: 11px; color: #ccc; height: 14px; }
    #buttonBox { margin-top: 10px; display: flex; gap: 6px; }
  </style>
</head>
<body>
  <h1>OWSOT - Dashboard</h1>

  <div class="row">
    <h2>HUD Type</h2>
    <label>Type:
      <select id="hudType">
        <option value="normal">Default</option>
        <option value="payload">Payload</option>
      </select>
    </label>
  </div>

  <div class="row">
    <h2>Team 1</h2>
    <label>Team Name: <input id="team1name" placeholder="Team A" /></label>
    <label>Score: <input id="team1score" type="number" value="0" style="width:60px"></label>
    <label>Total Score: <input id="team1total" placeholder="0W 0L |" /></label>
    <label>Logo File: <input type="file" id="team1logoFile" accept="image/*" style="width:180px"></label>
    <label>Ban:
      <select id="team1ban"><option value="">(Pick)</option></select>
    </label>
    <label class="side-input">Side:
      <select id="team1side">
        <option value="none">(Pick)</option>
        <option value="attack">Attack</option>
        <option value="defense">Defense</option>
      </select>
    </label>
  </div>

  <div class="row">
    <h2>Team 2</h2>
    <label>Team Name: <input id="team2name" placeholder="Team B" /></label>
    <label>Score: <input id="team2score" type="number" value="0" style="width:60px"></label>
    <label>Total Score: <input id="team2total" placeholder="| 0W 0L" /></label>
    <label>Logo File: <input type="file" id="team2logoFile" accept="image/*" style="width:180px"></label>
    <label>Ban:
      <select id="team2ban"><option value="">(Pick)</option></select>
    </label>
    <label class="side-input">Side:
      <select id="team2side">
        <option value="none">(Pick)</option>
        <option value="attack">Attack</option>
        <option value="defense">Defense</option>
      </select>
    </label>
  </div>

  <div class="row">
    <h2>Match Info</h2>
    <label>Map #: <input id="mapNum" type="number" value="1" style="width:60px"></label>
    <label>First To: <input id="firstTo" type="number" value="3" style="width:60px"></label>
    <label>Set Results: <input id="setResults" placeholder="Team A, Team B, Team A" style="width:240px"></label>
  </div>

  <div class="row">
    <h2>Descriptions</h2>
    <label>Text:
      <input id="descriptions" placeholder="ex. Finals - Match Point" style="width:240px" />
    </label>
  </div>

  <div id="buttonBox">
    <button id="updateBtn">Update</button>
    <button id="resetBtn" style="background:#e74c3c;">Reset</button>
  </div>
  <div id="status"></div>

  <script>
    const statusEl = document.getElementById("status");
    const hudTypeSelect = document.getElementById("hudType");

    function updateSideVisibility() {
      const isPayload = hudTypeSelect.value === "payload";
      document.querySelectorAll(".side-input").forEach(el => {
        el.style.display = isPayload ? "block" : "none";
      });
    }
    hudTypeSelect.addEventListener("change", updateSideVisibility);

    async function loadHeroList() {
      try {
        const res = await fetch("http://localhost:3000/hero-list");
        const heroes = await res.json();
        const team1ban = document.getElementById("team1ban");
        const team2ban = document.getElementById("team2ban");
        heroes.forEach(hero => {
          const name = hero.replace(/\.[^.]+$/, "");
          team1ban.add(new Option(name, name));
          team2ban.add(new Option(name, name));
        });
      } catch {}
    }

    async function uploadLogo(fileInput) {
      if (!fileInput.files.length) return '';
      const formData = new FormData();
      formData.append('logo', fileInput.files[0]);
      const res = await fetch('http://localhost:3000/upload-logo', { method: 'POST', body: formData });
      const data = await res.json();
      return data.filePath;
    }

    async function onUpdate(){
      const btn = document.getElementById("updateBtn");
      btn.disabled = true;
      statusEl.textContent = "Updating...";

      const body = {
        hudType: document.getElementById("hudType").value,
        descriptions: document.getElementById("descriptions").value || "",
        team1: {
          name: document.getElementById("team1name").value || "Team A",
          score: +document.getElementById("team1score").value || 0,
          total: document.getElementById("team1total").value || "0W 0L |",
          logo: await uploadLogo(document.getElementById("team1logoFile")) || '',
          bans:[document.getElementById("team1ban").value || "hero1"],
          side: document.getElementById("team1side").value || "none"
        },
        team2: {
          name: document.getElementById("team2name").value || "Team B",
          score: +document.getElementById("team2score").value || 0,
          total: document.getElementById("team2total").value || "| 0W 0L",
          logo: await uploadLogo(document.getElementById("team2logoFile")) || '',
          bans:[document.getElementById("team2ban").value || "hero2"],
          side: document.getElementById("team2side").value || "none"
        },
        mapNumber:+document.getElementById("mapNum").value || 1,
        firstTo:+document.getElementById("firstTo").value || 3,
        setResults:(document.getElementById("setResults").value || "")
          .split(",").map(x=>x.trim()).filter(x=>x)
      };

      try{
        const res = await fetch("http://localhost:3000/update",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(body)
        });
        if(!res.ok) throw new Error();
        statusEl.textContent="✅ Updated Successfully";
      }catch{
        statusEl.textContent="❌ Failed to connect to server";
      }finally{
        btn.disabled=false;
        setTimeout(()=>statusEl.textContent="",1500);
      }
    }

    document.getElementById("updateBtn").addEventListener("click",onUpdate);
    document.getElementById("resetBtn").addEventListener("click",()=>location.reload());
    loadHeroList();
    updateSideVisibility();
  </script>
</body>
</html>
